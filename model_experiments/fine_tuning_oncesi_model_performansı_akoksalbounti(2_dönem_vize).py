# -*- coding: utf-8 -*-
"""Fine_tuning_oncesi_model_performansÄ±_akoksalbounti(2.dÃ¶nem_vize).ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1d0wjoGwLuzhj52MO3zUi9YK9yBm3vsUI
"""

!pip install transformers datasets scikit-learn torch

import pandas as pd
from transformers import AutoModelForSequenceClassification, AutoTokenizer, pipeline
from sklearn.metrics import accuracy_score, precision_recall_fscore_support

# ğŸ“‚ CSV DosyasÄ±nÄ± YÃ¼kle (Test Verisi)
# Burada kendi CSV dosyanÄ± yÃ¼klemen gerekiyor. CSV dosyasÄ±nda 'text' ve 'sentiment' sÃ¼tunlarÄ± olmalÄ±.
# 'text' sÃ¼tunundaki metinler model tarafÄ±ndan analiz edilecek, 'sentiment' ise gerÃ§ek duygu etiketlerini iÃ§eriyor.
df = pd.read_csv("/content/drive/MyDrive/random_50_labeled_tweets.csv")

# BirkaÃ§ satÄ±rÄ± kontrol edelim
print(df.head())

# EÄŸer 'text' ve 'label' sÃ¼tunlarÄ±ndaki isimler farklÄ±ysa, ona gÃ¶re dÃ¼zenle.
# Ã–rneÄŸin, 'text' yerine 'review' veya 'sentence' gibi bir isim olabilir.
# df['text'] ve df['label'] olarak gÃ¼ncelle.

#Model ve tokenizer yÃ¼kleme
model_name = "akoksal/bounti" # Bounti modelini kullanÄ±yoruz
tokenizer = AutoTokenizer.from_pretrained(model_name)
model = AutoModelForSequenceClassification.from_pretrained(model_name)

print(model.config)

# ğŸ’¬ Sentiment Analysis Pipeline oluÅŸturma
nlp_pipeline = pipeline("text-classification", model=model, tokenizer=tokenizer)

# ğŸ§ª Test Veri Setini Modelle Test Et
# Bu adÄ±mda, modelin 'text' sÃ¼tunundaki her metni analiz etmesini saÄŸlÄ±yoruz.
# Modelin verdiÄŸi tahminler 'predicted_label' sÃ¼tununa yazÄ±lacak.
# text â†’ Metinleri iÃ§erir. (Ã–nceden var)
# label â†’ GerÃ§ek etiketler. (Ã–nceden var)
# predicted_label â†’ Modelin tahmin ettiÄŸi etiketler. (Yeni eklenen sÃ¼tun)

# ğŸ§ª 3ï¸âƒ£ Test Veri Setini Modelle Test Et
# Model 'text' sÃ¼tunundaki her metni analiz edecek
df["predicted_label"] = df["text"].apply(lambda x: nlp_pipeline(x)[0]["label"])

# ğŸ”„ 4ï¸âƒ£ Ä°ngilizce â†’ TÃ¼rkÃ§e Etiket Ã‡evirisi
label_mapping = {
    "positive": "pozitif",
    "negative": "negatif",
    "neutral": "nÃ¶tr"
}
df["predicted_label"] = df["predicted_label"].map(label_mapping)

# ğŸ” 5ï¸âƒ£ GerÃ§ek ve Tahmin Etiketlerini Kontrol Et
print(df.head())  # Ä°lk 5 satÄ±rÄ± yazdÄ±rarak her ÅŸeyin doÄŸru Ã§alÄ±ÅŸtÄ±ÄŸÄ±nÄ± gÃ¶r

# ğŸ“Š 6ï¸âƒ£ Metrikleri Hesapla
true_labels = df["sentiment"]
predicted_labels = df["predicted_label"]

accuracy = accuracy_score(true_labels, predicted_labels)
precision, recall, f1, _ = precision_recall_fscore_support(true_labels, predicted_labels, average='macro', zero_division=1)

# ğŸ“ 7ï¸âƒ£ SonuÃ§larÄ± YazdÄ±r
print(f"Accuracy: {accuracy:.4f}")
print(f"Precision: {precision:.4f}")
print(f"Recall: {recall:.4f}")
print(f"F1-Score: {f1:.4f}")

# ğŸ’¾ 8ï¸âƒ£ SonuÃ§larÄ± Yeni Bir CSV DosyasÄ±na Kaydet
df.to_csv("test_sonuclari.csv", index=False)

import pandas as pd
from transformers import AutoModelForSequenceClassification, AutoTokenizer, pipeline
from sklearn.metrics import accuracy_score, precision_recall_fscore_support, confusion_matrix
import seaborn as sns
import matplotlib.pyplot as plt

# ğŸ“‚ 1ï¸âƒ£ CSV DosyasÄ±nÄ± YÃ¼kle
df = pd.read_csv("/content/drive/MyDrive/random_50_labeled_tweets.csv")

print("\nğŸ” Veri setindeki ilk 5 satÄ±r:")
print(df[["text", "sentiment"]].head())

# ğŸ§¾ 2ï¸âƒ£ Veri Seti Etiketlerini Kontrol Et
print("\nğŸ“Š Veri setindeki benzersiz GERÃ‡EK etiketler:")
print(df["sentiment"].value_counts())
print("Benzersiz deÄŸerler:", df["sentiment"].unique())

# ğŸ”§ 3ï¸âƒ£ Model ve tokenizer yÃ¼kleme
model_name = "akoksal/bounti"
tokenizer = AutoTokenizer.from_pretrained(model_name)
model = AutoModelForSequenceClassification.from_pretrained(model_name)
print("\nğŸ“Œ Modelin configâ€™inden id2label:")
print(model.config.id2label)

# ğŸ’¬ 4ï¸âƒ£ Sentiment Analysis Pipeline
nlp_pipeline = pipeline("text-classification", model=model, tokenizer=tokenizer)

# ğŸ” 5ï¸âƒ£ Tahminleri Al
df["predicted_raw"] = df["text"].apply(lambda x: nlp_pipeline(x)[0]["label"])

# ğŸ§­ 6ï¸âƒ£ Tahmin Etiketlerini (English â†’ TÃ¼rkÃ§e) Map Et
label_mapping = {
    "positive": "pozitif",
    "negative": "negatif",
    "neutral": "nÃ¶tr"
}

df["predicted_label"] = df["predicted_raw"].map(label_mapping)

# â— 7ï¸âƒ£ EÄŸer map baÅŸarÄ±sÄ±zsa (None dÃ¶nerse) uyarÄ± ver
nan_count = df["predicted_label"].isna().sum()
if nan_count > 0:
    print(f"\nâ— UYARI: {nan_count} tahmin eÅŸleÅŸmedi. Tahmin deÄŸerleri ÅŸunlardÄ±:")
    print(df["predicted_raw"].value_counts())
    print("Map iÅŸlemi sonrasÄ± oluÅŸan eÅŸsiz predicted_label deÄŸerleri:", df["predicted_label"].unique())

# ğŸ” 8ï¸âƒ£ Etiket KarÅŸÄ±laÅŸtÄ±rmasÄ±
print("\nâœ… Etiket KarÅŸÄ±laÅŸtÄ±rmasÄ±:")
print("GerÃ§ek Etiketler:")
print(df["sentiment"].value_counts())
print("\nModel Tahmin Etiketleri:")
print(df["predicted_label"].value_counts())

# ğŸ” GerÃ§ek etiketleri kÃ¼Ã§Ã¼k harfe Ã§evir (uyumluluk iÃ§in)
df["sentiment"] = df["sentiment"].str.lower()


# ğŸ“ 9ï¸âƒ£ Metrik Hesaplama
true_labels = df["sentiment"]
predicted_labels = df["predicted_label"]



accuracy = accuracy_score(true_labels, predicted_labels)
precision, recall, f1, _ = precision_recall_fscore_support(true_labels, predicted_labels, average='macro', zero_division=1)

print("\nğŸ“Š Model PerformansÄ±:")
print(f"Accuracy: {accuracy:.4f}")
print(f"Precision (macro): {precision:.4f}")
print(f"Recall (macro): {recall:.4f}")
print(f"F1 Score (macro): {f1:.4f}")

# ğŸ§¯ 10ï¸âƒ£ YanlÄ±ÅŸ Tahmin Edilen Ã–rnekler
wrong_df = df[df["sentiment"] != df["predicted_label"]]
print(f"\nâŒ YanlÄ±ÅŸ tahmin edilen Ã¶rnek sayÄ±sÄ±: {len(wrong_df)}")
print("ğŸ” YanlÄ±ÅŸ tahmin Ã¶rneklerinden bazÄ±larÄ±:")
print(wrong_df[["text", "sentiment", "predicted_label"]].head())

# ğŸ§® 11ï¸âƒ£ Confusion Matrix
conf_matrix = confusion_matrix(true_labels, predicted_labels, labels=["pozitif", "negatif", "nÃ¶tr"])
plt.figure(figsize=(8, 6))
sns.heatmap(conf_matrix, annot=True, fmt='d', cmap='YlGnBu',
            xticklabels=["pozitif", "negatif", "nÃ¶tr"],
            yticklabels=["pozitif", "negatif", "nÃ¶tr"])
plt.xlabel("Tahmin")
plt.ylabel("GerÃ§ek")
plt.title("Confusion Matrix - Bounti Modeli")
plt.show()

# ğŸ’¾ 12ï¸âƒ£ Kaydetme
df.to_csv("bounti_model_test_sonuclari.csv", index=False)